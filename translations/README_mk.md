## C библиотека за DS18S20/DS18B20 сензор

### Краток опис

DS18S20library е AVR8 C библиотека за поврзување на температурните сензори: DS18S20 и DS18B20 со 8-bit Microchip AVR8 микроуправувачи.
Во библиотеката е спроведен 1-Wire протоколот за комуникација со DS18S20/DS18B20.

Првичните верзии на библиотеката се напишани за моделот DS18S20 на сензорот, но почнувајќи од веризијата 0.4, библиотеката исто така го поддржува и поновиот модел на сензорот DS18B20. 


### Поддржани AVR8 микроуправувачи

Библиотеката е компатибилна со секој 8-биттен Microchip AVR8 микроуправувач.

### Степен на поддржжшка за DS18x20 и имплементирани функции

Библиотеката работи со следниве модели на темературниот сензорот:

- DS18S20;
- DS18B20.

Истата може да се користи само кога DS18x20 сензорот се напојува со надворешен извор на напојување. Иако библиотеката вклучува функција која може да го одреди типот на напојувањето на сензорот,
оваа информација не се зема во предвид при понатамошната комуникација со сензорот.
Тековната верзија не поддржува 1-Wire магистрала на која се поврзани повеќе од еден уред. Оваа ограничување се должи на недостаток на методата SEARCH_ROM, со која библиотеката би можела да дознае кои се уреди се присутни на 1-Wire магистралата.  

Поддржани DS18x20 ROM наредби:

- DS18S20/DS18B20 подготовка на сензорот за користење;
- READ ROM наредба, за исчитување на ROM адресата на сензорот;
- SKIP ROM наредба, библиотеката може да зборува со сензорот диреткно, без користење на адресата на уредот на 1-Wire магистралата.

Поддржани DS18x20 функциски наредби:

- Convert T, наредба за започнување со единечна температурна конверзија;
- READ SCRATCHPAD, наредба за исчитување на содржината на внатрешната меморија на сензорот;
- READ POWER SUPPLY наредба за одредување на типот на напојувањето кај DS18S20/DS18B20;
- WRITE SCRATCHPAD наредба која му омозвожува на микроуправувачот да запишува 2 бајти во меморијата на DS18S20/DS18B20;
- COPY SCRATCHPAD наредба за копирање на содржината на регистрите: TH и TL (бајти под реден број 2 and 3) во EEPROM-от на сензорот;
- RECALL E2 повикување на граничните вредности за предизвикување на аларм (TH and TL) од EEPROM-от на сензорот.

#### Реализација на 1-Wire протоколот

Временските доцнења неопходни при софтверско спорведување на 1-Wire протоколот за комуникција се реализирани со временските функции кои се составен дел од avr-libc и дефинирани во заглавјето  
util/delay.h. Кај овие функции мерењето на времето е врзано со работната фрекфенција на микроуправачот, задедена преку макрото *F_CPU*. Вредноста на работната фрекфенција може да се дефинира глобално при преведувањето на кодот токму со оваа макро зададено како аргумент на преведувачот, во форма: *-DF_CPU=\<value\>L* . 
Ако макрото не е дефинирано, интерно, за фрекфенција на микроуправувачот ќе биде користена фрекфенција од 4MHz како подразбирлива вредност.

### Инсталација

Инсталацијата на библиотеката не е задолжителна, бидејќи изворните фајлови можат да се искористат директно во саканиот AVR8 проект заедно со веќе постоечките фајлови од самиот проект.
Сепак, постои можност кодот да се преведе во статичка библиотека за поврзување со бинарни објекти од други проекти. За таа цел, покрај  изворниот код, во проектот на располагање стојат и конфигурациски
фајлови за креирање на статичка библиотека со помош на алатките: make и cmake.

#### Креирање на статичка библиотека со make на Linux

Потребни алатки: make, avr-gcc и avr-libc инсталирани на Linux системот.

Изврши ја наредбарта make од командна линија наведувајќи ги при тоа аргументите за  тип на микроуправувач,  неговата работна фрекфенција и инсталациска папка:

```
#make MCU=attiny2313 CPU_FREQ=20000000L prefix=/home/username
```
Во наведениот пример, статичка библиотека ќе биде креирана за микроконтролерот ATtiny2313 со работна фрекфенција 20MHz и  /home/username/lib/avr8/attiny2313 како инсталациска папка.
Доколку некој од аргументите не е наведен при внес на командата make, нивните подразбирливи вредности се:
- MCU: atmega32
- CPU_FREQ: 16MHz
- префикс за локацијата на исталирање: /usr/local

По извршениот превод на кодот, инсталирај ја статичната библиотека со наредбарта:

```
#make install
```
или
```
#sudo make install
```
 доколку креирање на нови фајлови во инсталациската папка бара root привилегии.

#### Креирање на статичка библиотека со CMake на Linux

Потребни алатки: cmake, avr-gcc и avr-libc инсталирани на системот.

Креирај засебна папка во која ќе се спроведе преводот на изворниот код:
```
#mkdir build && cd build
```
Искористи го cmake за креирање на правила за превод на кодот
```
#cmake  -DCMAKE_TOOLCHAIN_FILE=../avr8_toolchain.cmake -DMCU=attiny2313 -DCPU_FREQ=20000000L -DCMAKE_INSTALL_PREFIX=/home/username/lib ..
```
во случај на ATtiny2313 со работна фрекфенција 20МHz и префикс за инсталациска папка /home/username/lib.Подразбирливите вредности за MCU и CPU_FREQ се исти како и
кај преводот со make. Во отсуство на аргументот за инсталациска локација, подразбирливата локација е: /usr/local/lib/avr8/\<mcu_name\> за библиотеката и /usr/local/include/avr8 за заглавјето
на библиотеката.

За преводот на изворниот код во статичка библиотека внеси ја наредбата:

```
#make
```

Самата инсталација се прави со истите наредби како и при користење на алатката make од погоре.


### Практична примена на кодот

Функцијата DS18x20_Init() е задолжена за подготовка на микроуправувачот за комуникација преку 1-Wire магристралата; за распознавање на моделот на сензорот (DS18B20 или DS18S20) и негова подготовка за комунијација со микроуправувачот. 

За дефинирање на 1-Wire магистралата од станата на микроуправувачот, DS18x20_Init() функцијата рапослага со два аргументи:

- адреса на портата на микроуправувачот преку која тој е врзан за 1-Wire магистрала;
- пин на микроуправувачот на кој е поврзан DQ пинот на DS18S20/DS18B20.

Првиот аргумент на функцијата е покажувач кон структурата TSDS18x20 преку која е дефиниран сензорот во рамките на библиотеката.  

На пример, во случај кога сензорот е поврзан на пинот 5 од портата D на микроуправувачот, тогаш функцијата за инизијализација не сензорот ќе се повика со следниве вредности на нејзините аргументи:

	TSDS18x20 DS18x20;

	DS18x20_Init(&DS18x20, &PORTD, PD5);

По извршената подготовка на сензорот и микроуправачот за комуникација со истиот, можат да се применат останатите функции и макроа кои ги нуди библиотеката за работа со сензорот.
Како не пример функцијата:

	DS18x20_MeasureTemperature(&DS18x20);

со која се започнува мерењето на температурата, нејзина конверзија во дигитална вредност и исчитување на измерената температура  од страна на микроуправувачот. Како единствен аргумент, на функцијата и се проследува истиот покажувач како и кај функцијата DS18x20_Init().

Функционалноста на библиотеката е тестирана со микроуправувачите: Atmega32 и Atiny2313.

### ПРЕДУПРЕДУВАЊЕ:
Изворниот код е достапен каков што е, без никаква гаранција за неговата функционалност и содржина. Користете го на сопствен ризик!
Авторот на кодот не презема никава одговорност за штети кои можеби би биле предизвикани со користење на овој код.

### ОГРАДУВАЊЕ: 
Изворниот кодот е резултат на хоби дејност и авторот не е поврзан ниту пак е во партнерство со некој од прозводителите на уреди/софтверски алатки спомнати во кодот, документацијата или описот на овој проект. Авторот не искажува никаква поврзаност со, претензија или сопственост врз трговските имиња наведени во проектот. Сите трговски имиња и заштитни знаци се во сопсвеност на нивните иматели.
